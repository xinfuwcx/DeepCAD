# 可视化模块扩展方案 - 保持现有风格
**基于现有代码**: PostProcessingPanel.tsx + PyVistaViewer.tsx  
**目标**: 为固体力学和渗流分析扩展，保持参数和风格不变

---

## 📊 **现有风格分析**

### 🎨 **界面风格特色**
```tsx
// 现有的优秀设计特色
- Ant Design组件体系 (Card, Tabs, Slider, Select, Switch)
- 小尺寸组件 (size="small")
- 卡片式布局 (Card + TabPane)
- 图标+文字的Tab设计
- 滑块数值显示 (透明度: {opacity})
- 颜色标签系统 (Tag color="blue")
- 实时进度提示 (Progress + Alert)
- WebSocket实时更新
```

### 🎛️ **现有参数设置**
```tsx
// 分析类型 - 保持不变
<Option value="structural">结构分析</Option>
<Option value="thermal">传热分析</Option>
<Option value="geomechanics">岩土分析</Option>  // 👈 已有!
<Option value="coupled">耦合分析</Option>      // 👈 已有!

// 渲染设置 - 保持不变
render_mode: 'solid' | 'wireframe' | 'points' | 'transparent' | 'x-ray'
show_edges: boolean
opacity: number (0-1, step=0.1)
color_map: 'viridis' | 'plasma' | 'jet' | 'rainbow' | 'coolwarm'

// 变形显示 - 保持不变
show_deformation: boolean
deformation_scale: number (0.1-10.0, step=0.1)
```

---

## 🚀 **扩展方案：在现有基础上增加**

### **方案1: 在现有TabPane中增加子选项**

#### **扩展"分析"Tab - 增加渗流参数**
```tsx
// 在现有的 renderAnalysisSettings() 中增加
const renderAnalysisSettings = () => (
  <Space direction="vertical" style={{ width: '100%' }}>
    {/* 现有的分析类型选择 - 保持不变 */}
    <div>
      <Text strong>分析类型:</Text>
      <Select value={analysisType} onChange={setAnalysisType}>
        <Option value="structural">结构分析</Option>
        <Option value="geomechanics">岩土分析</Option>
        <Option value="seepage">渗流分析</Option>      {/* 👈 新增 */}
        <Option value="coupled">耦合分析</Option>
      </Select>
    </div>

    {/* 🆕 根据分析类型显示不同参数 */}
    {analysisType === 'seepage' && (
      <div style={{ background: '#f6ffed', padding: 8, borderRadius: 4 }}>
        <Text strong style={{ color: '#52c41a' }}>渗流分析参数:</Text>
        <Row gutter={8} style={{ marginTop: 4 }}>
          <Col span={12}>
            <Text>渗透系数:</Text>
            <InputNumber
              value={seepageParams.permeability}
              onChange={(value) => setSeepageParams({...seepageParams, permeability: value})}
              min={1e-9}
              max={1e-3}
              step={1e-6}
              size="small"
              style={{ width: '100%' }}
            />
          </Col>
          <Col span={12}>
            <Text>水位(m):</Text>
            <InputNumber
              value={seepageParams.water_level}
              onChange={(value) => setSeepageParams({...seepageParams, water_level: value})}
              min={-50}
              max={10}
              step={0.5}
              size="small"
              style={{ width: '100%' }}
            />
          </Col>
        </Row>
      </div>
    )}

    {/* 现有的网格参数 - 保持不变 */}
    <Row gutter={8}>
      <Col span={12}>
        <Text>节点数:</Text>
        <InputNumber value={meshNodes} onChange={setMeshNodes} />
      </Col>
      <Col span={12}>
        <Text>单元数:</Text>
        <InputNumber value={meshElements} onChange={setMeshElements} />
      </Col>
    </Row>
  </Space>
);
```

#### **扩展"字段"Tab - 增加渗流字段**
```tsx
// 在现有字段选择中增加渗流字段选项
const getAvailableFields = (analysisType: string) => {
  const baseFields = [
    // 结构字段 - 保持现有
    { name: 'von_mises_stress', display_name: 'Von Mises应力', unit: 'Pa' },
    { name: 'displacement', display_name: '位移', unit: 'm' },
    { name: 'strain', display_name: '应变', unit: '-' },
  ];

  if (analysisType === 'seepage') {
    return [
      ...baseFields,
      // 🆕 渗流字段
      { name: 'hydraulic_head', display_name: '水头', unit: 'm' },
      { name: 'pore_pressure', display_name: '孔隙水压力', unit: 'Pa' },
      { name: 'seepage_velocity', display_name: '渗流速度', unit: 'm/s' },
      { name: 'flow_rate', display_name: '流量', unit: 'm³/s' }
    ];
  }
  
  return baseFields;
};
```

### **方案2: 新增专门的渗流Tab**

#### **在现有Tabs中增加"渗流"Tab**
```tsx
<Tabs size="small" type="card">
  {/* 现有Tab保持不变 */}
  <TabPane tab={<span><ThunderboltOutlined />分析</span>} key="analysis">
    {renderAnalysisSettings()}
  </TabPane>
  
  <TabPane tab={<span><HeatMapOutlined />字段</span>} key="fields">
    {renderFieldControls()}
  </TabPane>
  
  <TabPane tab={<span><CompressOutlined />变形</span>} key="deformation">
    {renderDeformationControls()}
  </TabPane>

  {/* 🆕 新增渗流专用Tab */}
  {(analysisType === 'seepage' || analysisType === 'coupled') && (
    <TabPane tab={<span><CloudOutlined />渗流</span>} key="seepage">
      {renderSeepageControls()}
    </TabPane>
  )}
</Tabs>
```

#### **渗流控制面板 - 遵循现有风格**
```tsx
const renderSeepageControls = () => (
  <Space direction="vertical" style={{ width: '100%' }}>
    {/* 边界条件显示控制 */}
    <div>
      <Text strong>边界条件显示:</Text>
      <Space wrap style={{ marginTop: 4 }}>
        <Switch 
          checkedChildren="定水头" 
          unCheckedChildren="定水头"
          checked={seepageBoundary.constant_head}
          onChange={(checked) => setSeepageBoundary({...seepageBoundary, constant_head: checked})}
          size="small"
        />
        <Switch 
          checkedChildren="不透水" 
          unCheckedChildren="不透水"
          checked={seepageBoundary.impermeable}
          onChange={(checked) => setSeepageBoundary({...seepageBoundary, impermeable: checked})}
          size="small"
        />
        <Switch 
          checkedChildren="渗出面" 
          unCheckedChildren="渗出面"
          checked={seepageBoundary.seepage_face}
          onChange={(checked) => setSeepageBoundary({...seepageBoundary, seepage_face: checked})}
          size="small"
        />
      </Space>
    </div>

    {/* 流线显示控制 - 遵循现有滑块风格 */}
    <div>
      <Text strong>流线密度: {streamlineSettings.density}</Text>
      <Slider
        min={0.1}
        max={2.0}
        step={0.1}
        value={streamlineSettings.density}
        onChange={(value) => setStreamlineSettings({...streamlineSettings, density: value})}
        tooltip={{ formatter: (value) => `${value}x` }}
      />
    </div>

    {/* 渗流动画控制 - 遵循现有动画风格 */}
    <div>
      <Text strong>渗流演化动画:</Text>
      <Row gutter={8} style={{ marginTop: 4 }}>
        <Col span={12}>
          <Button
            icon={seepageAnimation.playing ? <PauseOutlined /> : <PlayCircleOutlined />}
            onClick={() => toggleSeepageAnimation()}
            block
            size="small"
          >
            {seepageAnimation.playing ? '暂停' : '播放'}
          </Button>
        </Col>
        <Col span={12}>
          <Button
            icon={<ReloadOutlined />}
            onClick={() => resetSeepageAnimation()}
            block
            size="small"
          >
            重置
          </Button>
        </Col>
      </Row>
    </div>

    {/* 时间控制 - 遵循现有时间滑块风格 */}
    <div>
      <Text>时间: {currentTime.toFixed(1)} 天</Text>
      <Slider
        min={0}
        max={totalTime}
        value={currentTime}
        onChange={setCurrentTime}
        tooltip={{ formatter: (value) => `${value} 天` }}
      />
    </div>
  </Space>
);
```

### **方案3: 扩展PyVistaViewer的渲染模式**

#### **在现有渲染模式中增加渗流专用模式**
```tsx
// 在现有的渲染设置Tab中增加
<div>
  <Text strong>渲染模式:</Text>
  <Select value={renderSettings.render_mode} onChange={updateRenderMode}>
    {/* 现有模式保持不变 */}
    <Option value="solid">实体</Option>
    <Option value="wireframe">线框</Option>
    <Option value="points">点云</Option>
    <Option value="transparent">透明</Option>
    <Option value="x-ray">X射线</Option>
    
    {/* 🆕 渗流专用模式 */}
    {(analysisType === 'seepage' || analysisType === 'coupled') && [
      <Option key="streamlines" value="streamlines">流线模式</Option>,
      <Option key="flow_vectors" value="flow_vectors">流速矢量</Option>,
      <Option key="contour_filled" value="contour_filled">填充等值线</Option>
    ]}
  </Select>
</div>

{/* 🆕 渗流模式专用设置 - 仅在渗流模式时显示 */}
{renderSettings.render_mode === 'streamlines' && (
  <div style={{ background: '#e6f7ff', padding: 8, borderRadius: 4 }}>
    <Text strong style={{ color: '#1890ff' }}>流线设置:</Text>
    <div style={{ marginTop: 4 }}>
      <Text>起始点密度: {streamlineSettings.start_density}</Text>
      <Slider
        min={10}
        max={100}
        step={5}
        value={streamlineSettings.start_density}
        onChange={(value) => setStreamlineSettings({...streamlineSettings, start_density: value})}
        tooltip={{ formatter: (value) => `${value}点` }}
      />
    </div>
    <div>
      <Text>流线长度: {streamlineSettings.max_length}</Text>
      <Slider
        min={1}
        max={10}
        step={0.5}
        value={streamlineSettings.max_length}
        onChange={(value) => setStreamlineSettings({...streamlineSettings, max_length: value})}
        tooltip={{ formatter: (value) => `${value}m` }}
      />
    </div>
  </div>
)}
```

---

## 🎨 **颜色映射扩展 - 保持现有风格**

### **为渗流分析增加专门的颜色映射**
```tsx
// 在现有颜色映射基础上增加渗流专用
const getColorMappingOptions = (analysisType: string, currentField: string) => {
  // 现有的通用颜色映射 - 保持不变
  const baseColormaps = [
    <Option key="viridis" value="viridis">Viridis</Option>,
    <Option key="plasma" value="plasma">Plasma</Option>,
    <Option key="jet" value="jet">Jet</Option>,
    <Option key="rainbow" value="rainbow">Rainbow</Option>,
    <Option key="coolwarm" value="coolwarm">冷暖色</Option>
  ];

  // 🆕 渗流专用颜色映射
  if (analysisType === 'seepage') {
    const seepageColormaps = [
      <Option key="blues" value="blues">蓝色渐变 (水头)</Option>,
      <Option key="rdylbu" value="rdylbu">红黄蓝 (压力)</Option>,
      <Option key="seismic" value="seismic">地震色 (流速)</Option>
    ];
    
    return [...baseColormaps, ...seepageColormaps];
  }

  return baseColormaps;
};
```

---

## 📊 **数据字段扩展方案**

### **保持现有字段结构，增加渗流字段**
```tsx
// 现有字段信息接口 - 保持不变
interface FieldInfo {
  name: string;
  display_name: string;
  unit: string;
  data_range?: [number, number];
  colormap?: string;
}

// 🆕 渗流字段定义
const SEEPAGE_FIELDS: FieldInfo[] = [
  {
    name: 'hydraulic_head',
    display_name: '水头',
    unit: 'm',
    data_range: [-20, 5],
    colormap: 'blues'  // 蓝色适合水头
  },
  {
    name: 'pore_pressure', 
    display_name: '孔隙水压力',
    unit: 'kPa',
    data_range: [-50, 200],
    colormap: 'rdylbu'  // 红黄蓝适合压力
  },
  {
    name: 'seepage_velocity_magnitude',
    display_name: '渗流速度大小', 
    unit: 'm/day',
    data_range: [0, 0.1],
    colormap: 'viridis'  // 保持现有经典配色
  },
  {
    name: 'flow_rate',
    display_name: '单位流量',
    unit: 'm²/day',
    data_range: [0, 1.0],
    colormap: 'plasma'
  }
];
```

---

## 🔄 **WebSocket消息扩展 - 保持现有格式**

### **在现有消息处理中增加渗流事件**
```tsx
// 现有WebSocket处理 - 保持不变
const handleWebSocketMessage = (event: MessageEvent) => {
  const data = JSON.parse(event.data);
  
  switch (data.type) {
    // 现有消息类型保持不变
    case 'postprocessing_completed':
    case 'field_updated':  
    case 'colormap_updated':
    case 'deformation_updated':
      // 现有处理逻辑
      break;
      
    // 🆕 渗流专用消息类型
    case 'seepage_analysis_completed':
      handleSeepageAnalysisCompleted(data);
      break;
    case 'streamlines_updated':
      handleStreamlinesUpdated(data);  
      break;
    case 'seepage_animation_frame':
      handleSeepageAnimationFrame(data);
      break;
  }
};
```

---

## 📝 **实施建议**

### **Phase 1: 最小侵入式扩展**
1. **保持现有所有代码不变**
2. **在分析类型中增加"seepage"选项**
3. **在字段列表中增加渗流字段**  
4. **测试现有功能无影响**

### **Phase 2: 渐进式功能增加**
1. **增加渗流专用Tab（条件显示）**
2. **增加渗流专用颜色映射**
3. **增加流线渲染模式**
4. **测试新功能与现有功能的兼容性**

### **Phase 3: 深度集成优化**
1. **优化渗流动画性能**
2. **完善渗流边界条件显示**
3. **集成耦合分析可视化**
4. **全面测试和优化**

---

**总结**: 完全保持现有PostProcessingPanel和PyVistaViewer的优秀设计风格，通过条件显示、字段扩展、颜色映射增加等方式，无缝集成固体力学和渗流分析的可视化功能。所有现有参数、布局、交互方式保持不变。