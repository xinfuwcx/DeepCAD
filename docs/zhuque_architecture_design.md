# 深基坑分析系统 - 朱雀架构设计

## 1. 架构概述

朱雀架构是一种微服务架构，专为高性能工程计算软件设计，将系统分解为多个独立的服务，每个服务负责特定的功能。这种架构特别适合处理复杂的工程计算组件，如Kratos求解器、Gmsh网格生成、OpenCascade几何处理和DXF文件处理等。

### 1.1 设计原则

- **计算密集型服务隔离**：将计算密集型任务（如有限元分析、网格生成）与IO密集型任务（如文件处理、用户界面）分离
- **数据流优先**：基于数据流的服务设计，减少不必要的数据传输
- **可伸缩性**：支持水平扩展，特别是计算密集型服务
- **容错性**：服务之间的故障隔离
- **渐进式迁移**：支持从单体架构到微服务架构的平滑过渡

### 1.2 当前状态：单体架构
- **前端**：React + TypeScript + Three.js
- **后端**：FastAPI + Python
- **核心模块**：几何引擎、分析引擎、网格生成器
- **存储**：文件系统 + SQLite

### 1.3 目标状态：微服务架构
基于朱雀架构的指导思想，我们将系统分解为多个微服务。

## 2. 服务拆分与配置

### 2.1 核心服务

1. **几何服务 (Geometry Service)**
   - 职责：几何建模、布尔运算、CAD文件处理
   - 技术栈：Python + Gmsh + OpenCASCADE
   - 端口：8001
   - 依赖组件：
     - OpenCascade: 几何核心引擎
     - Gmsh: 网格生成前的几何处理
     - DXF解析库: 处理CAD文件导入

2. **网格服务 (Mesh Service)**
   - 职责：网格生成、网格优化、网格质量检查
   - 技术栈：Python + Gmsh
   - 端口：8002
   - 依赖组件：
     - Gmsh: 主要网格生成引擎
     - TetGen: 体网格生成(可选)

3. **分析服务 (Analysis Service)**
   - 职责：有限元分析、Kratos求解器调用
   - 技术栈：Python + Kratos + NumPy
   - 端口：8003
   - 依赖组件：
     - Kratos: 多物理场求解器
     - NumPy/SciPy: 科学计算库

4. **结果服务 (Result Service)**
   - 职责：结果后处理、可视化数据生成
   - 技术栈：Python + VTK + PyVista
   - 端口：8004
   - 依赖组件：
     - VTK: 可视化工具包
     - PyVista: VTK的Python封装
     - Matplotlib: 2D绘图库

### 2.2 支撑服务

5. **项目服务 (Project Service)**
   - 职责：项目管理、用户数据、配置管理
   - 技术栈：Python + FastAPI + PostgreSQL
   - 端口：8005

6. **文件服务 (File Service)**
   - 职责：文件上传、存储、版本管理
   - 技术栈：Python + MinIO/S3
   - 端口：8006

7. **通知服务 (Notification Service)**
   - 职责：分析进度通知、结果推送
   - 技术栈：Python + WebSocket + Redis
   - 端口：8007

### 2.3 基础设施服务

8. **API网关 (API Gateway)**
   - 职责：请求路由、认证授权、限流熔断
   - 技术栈：Kong/Nginx + Lua
   - 端口：8000

9. **服务发现 (Service Discovery)**
   - 职责：服务注册、健康检查、负载均衡
   - 技术栈：Consul
   - 端口：8500

10. **配置中心 (Config Center)**
    - 职责：配置管理、动态更新
    - 技术栈：Consul
    - 端口：8501

## 3. 服务间通信设计

### 3.1 同步通信
- **协议**：HTTP/REST + gRPC
- **服务发现**：通过Consul进行服务注册和发现
- **负载均衡**：客户端负载均衡 + 服务端负载均衡

### 3.2 异步通信
- **消息队列**：RabbitMQ
- **事件驱动**：分析任务状态变更、结果生成完成等事件
- **模式**：发布/订阅、工作队列

## 4. 数据架构设计

### 4.1 数据分离原则
- **几何数据**：存储在几何服务的本地文件系统
- **网格数据**：存储在网格服务的本地文件系统
- **分析结果**：存储在分布式对象存储（MinIO）
- **项目元数据**：存储在项目服务的PostgreSQL数据库
- **用户会话**：存储在Redis缓存

### 4.2 数据一致性
- **最终一致性**：通过事件驱动保证数据最终一致
- **分布式事务**：使用Saga模式处理跨服务事务
- **数据版本控制**：为关键数据提供版本管理

## 5. 可观测性设计

### 5.1 日志系统
- **日志收集**：ELK Stack (Elasticsearch + Logstash + Kibana)
- **日志格式**：结构化日志 (JSON格式)
- **日志级别**：DEBUG/INFO/WARN/ERROR

### 5.2 监控系统
- **指标收集**：Prometheus + Grafana
- **健康检查**：每个服务提供/health端点
- **性能监控**：CPU、内存、磁盘、网络指标

### 5.3 链路追踪
- **追踪系统**：Jaeger
- **追踪范围**：API网关 -> 各个微服务的完整调用链
- **性能分析**：识别性能瓶颈和异常

## 6. 分阶段实施计划

### 阶段1：基础设施准备与计算界面优化（2周）
- [ ] 搭建Docker开发环境
- [ ] 部署Consul服务发现
- [ ] 配置API网关
- [ ] 优化计算界面，增强Kratos求解器集成
- [ ] 增强材料管理和边界条件设置功能

### 阶段2：几何服务独立（3周）
- [ ] 设计几何服务API
- [ ] 实现Gmsh和OpenCascade集成
- [ ] 实现DXF文件处理
- [ ] 编写Docker配置
- [ ] 集成到API网关

### 阶段3：网格服务独立（2周）
- [ ] 设计网格服务API
- [ ] 实现Gmsh网格生成
- [ ] 提供网格优化功能
- [ ] 编写Docker配置
- [ ] 集成到API网关

### 阶段4：分析服务独立（3周）
- [ ] 设计分析服务API
- [ ] 实现Kratos求解器集成
- [ ] 提供多物理场分析功能
- [ ] 编写Docker配置
- [ ] 集成到API网关

### 阶段5：结果服务独立（2周）
- [ ] 设计结果服务API
- [ ] 实现VTK和PyVista集成
- [ ] 提供可视化数据生成
- [ ] 编写Docker配置
- [ ] 集成到API网关

### 阶段6：支撑服务完善（4周）
- [ ] 项目服务开发
- [ ] 文件服务开发
- [ ] 通知服务开发
- [ ] 完善监控和日志系统

### 阶段7：系统集成与测试（2周）
- [ ] 端到端测试
- [ ] 性能测试
- [ ] 负载测试
- [ ] 文档完善

## 7. 风险控制

### 7.1 技术风险
- **复杂依赖管理**：使用Docker容器隔离环境，预构建包含所有依赖的基础镜像
- **性能瓶颈**：实现任务队列和异步处理，允许长时间运行的任务在后台执行
- **服务通信开销**：合理设计API边界，减少跨服务调用，使用缓存减少重复请求

### 7.2 运维风险
- **服务监控**：完善的监控和告警机制
- **故障恢复**：自动故障检测和恢复
- **数据备份**：定期数据备份和恢复演练

### 7.3 业务风险
- **向后兼容**：保持API向后兼容性
- **渐进迁移**：分阶段迁移，确保业务连续性
- **回滚方案**：每个阶段都有回滚预案

## 8. 成功指标

### 8.1 技术指标
- **响应时间**：API响应时间 < 100ms
- **可用性**：系统可用性 > 99.9%
- **吞吐量**：并发用户数 > 1000

### 8.2 业务指标
- **分析效率**：分析任务完成时间缩短50%
- **系统稳定性**：故障恢复时间 < 5分钟
- **开发效率**：新功能开发周期缩短30%

---

本设计文档提供了朱雀架构的完整实施方案，通过分阶段实施，可以在保证业务连续性的前提下，逐步将系统演进为高可用、高性能的分布式架构。 