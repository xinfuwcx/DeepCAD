<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>geo-three瓦片渲染测试</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: 'Monaco', 'Menlo', monospace;
            overflow: hidden;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ffff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #00ffff;
            z-index: 1000;
            max-width: 400px;
            font-size: 12px;
            line-height: 1.4;
        }

        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ffffff;
            z-index: 1000;
        }

        button {
            background: #0080ff;
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 3px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        button:hover {
            background: #00aaff;
        }

        .status {
            color: #00ff00;
            font-weight: bold;
        }

        .error {
            color: #ff4444;
            font-weight: bold;
        }

        .warning {
            color: #ffaa00;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    
    <div id="info">
        <h3 style="margin: 0 0 10px 0; color: #00ffff;">🗺️ geo-three瓦片渲染测试</h3>
        <div id="status">初始化中...</div>
        <div style="margin-top: 10px;">
            <div>瓦片加载状态：<span id="tile-status">等待中</span></div>
            <div>已加载瓦片：<span id="tile-count">0</span></div>
            <div>渲染帧率：<span id="fps">0</span> FPS</div>
            <div>相机位置：<span id="camera-pos">未知</span></div>
        </div>
    </div>

    <div id="controls">
        <h4 style="margin: 0 0 10px 0;">地图控制</h4>
        <button onclick="switchMapStyle('street')">🗺️ 街道</button>
        <button onclick="switchMapStyle('satellite')">🛰️ 卫星</button>
        <button onclick="switchMapStyle('terrain')">⛰️ 地形</button>
        <button onclick="switchMapStyle('dark')">🌙 暗色</button>
        <br/>
        <button onclick="addTestMarkers()">📌 添加测试标记</button>
        <button onclick="flyToShanghai()">✈️ 飞往上海</button>
        <button onclick="resetView()">🔄 重置视图</button>
    </div>

    <!-- 引入Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r155/three.min.js"></script>
    
    <script>
        console.log('🚀 开始geo-three瓦片渲染测试...');
        
        // 全局变量
        let scene, camera, renderer;
        let tiles = new Map();
        let currentStyle = 'street';
        let center = { lat: 31.2304, lng: 121.4737 }; // 上海
        let zoom = 8;
        let tileScale = 10;
        let frameCount = 0;
        let lastTime = performance.now();

        // 瓦片提供者类
        class TileProvider {
            constructor() {
                this.styleUrls = {
                    street: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
                    satellite: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
                    terrain: 'https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',
                    dark: 'https://cartodb-basemaps-a.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png'
                };
            }

            getTileUrl(style, zoom, x, y) {
                const template = this.styleUrls[style] || this.styleUrls.street;
                return template
                    .replace('{z}', zoom.toString())
                    .replace('{x}', x.toString())
                    .replace('{y}', y.toString());
            }

            lngLatToTile(lng, lat, zoom) {
                const latRad = lat * Math.PI / 180;
                const n = Math.pow(2, zoom);
                const x = Math.floor((lng + 180) / 360 * n);
                const y = Math.floor((1 - Math.asinh(Math.tan(latRad)) / Math.PI) / 2 * n);
                return { x, y, z: zoom };
            }

            getTileWorldPosition(tileX, tileY, centerTile, scale) {
                const offsetX = (tileX - centerTile.x) * scale;
                const offsetY = -(tileY - centerTile.y) * scale;
                return new THREE.Vector3(offsetX, 0, offsetY);
            }
        }

        // 瓦片类
        class MapTile {
            constructor(tileCoord, worldPosition, scale) {
                this.tileCoord = tileCoord;
                this.worldPosition = worldPosition;
                this.scale = scale;
                this.texture = null;
                
                // 创建几何体和材质
                this.geometry = new THREE.PlaneGeometry(scale, scale);
                this.material = new THREE.MeshBasicMaterial({ 
                    color: 0x66ccff,
                    transparent: false,
                    opacity: 1.0,
                    side: THREE.DoubleSide
                });
                
                this.mesh = new THREE.Mesh(this.geometry, this.material);
                this.mesh.position.copy(worldPosition);
                this.mesh.rotation.x = -Math.PI / 2;
                
                this.loader = new THREE.TextureLoader();
                this.loader.crossOrigin = 'anonymous';
            }

            async loadTexture(provider, style) {
                return new Promise((resolve) => {
                    const url = provider.getTileUrl(style, this.tileCoord.z, this.tileCoord.x, this.tileCoord.y);
                    console.log(`🌐 加载瓦片纹理: ${url}`);
                    
                    this.loader.load(
                        url,
                        (texture) => {
                            texture.flipY = false;
                            texture.wrapS = THREE.ClampToEdgeWrapping;
                            texture.wrapT = THREE.ClampToEdgeWrapping;
                            texture.minFilter = THREE.LinearFilter;
                            texture.magFilter = THREE.LinearFilter;
                            
                            // 应用纹理
                            this.material.map = texture;
                            this.material.color.set(0xffffff);
                            this.material.needsUpdate = true;
                            this.texture = texture;
                            
                            console.log(`✅ 瓦片纹理加载成功: ${this.tileCoord.z}/${this.tileCoord.x}/${this.tileCoord.y}`);
                            updateTileCount();
                            resolve();
                        },
                        (progress) => {
                            // console.log(`📊 加载进度: ${((progress.loaded / progress.total) * 100).toFixed(1)}%`);
                        },
                        (error) => {
                            console.warn(`⚠️ 瓦片加载失败: ${this.tileCoord.z}/${this.tileCoord.x}/${this.tileCoord.y}`, error);
                            this.material.color.set(0xff6666);
                            this.material.needsUpdate = true;
                            resolve();
                        }
                    );
                });
            }
        }

        // 初始化Three.js
        function initThreeJS() {
            const container = document.getElementById('container');
            
            // 场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x001122);
            scene.fog = new THREE.Fog(0x001122, 50, 200);
            
            // 相机
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 25, 25);
            camera.lookAt(0, 0, 0);
            
            // 渲染器
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            container.appendChild(renderer.domElement);
            
            // 灯光
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            console.log('✅ Three.js初始化完成');
            updateStatus('Three.js初始化完成', 'status');
        }

        // 加载可视瓦片
        async function loadVisibleTiles() {
            console.log('🗺️ 开始加载可视瓦片...');
            updateStatus('正在加载瓦片...', 'warning');
            
            const tileProvider = new TileProvider();
            const centerTile = tileProvider.lngLatToTile(center.lng, center.lat, zoom);
            const tileRadius = 3; // 3x3网格
            
            console.log(`📊 瓦片范围: 中心(${centerTile.x}, ${centerTile.y}), 半径=${tileRadius}, 缩放=${zoom}`);
            
            const loadPromises = [];
            let tilesCreated = 0;
            
            for (let x = centerTile.x - tileRadius; x <= centerTile.x + tileRadius; x++) {
                for (let y = centerTile.y - tileRadius; y <= centerTile.y + tileRadius; y++) {
                    const tileKey = `${zoom}_${x}_${y}`;
                    
                    if (!tiles.has(tileKey)) {
                        const tileCoord = { x, y, z: zoom };
                        const worldPos = tileProvider.getTileWorldPosition(x, y, centerTile, tileScale);
                        
                        console.log(`🎯 创建瓦片 ${tileKey} 在位置 (${worldPos.x.toFixed(2)}, ${worldPos.y.toFixed(2)}, ${worldPos.z.toFixed(2)})`);
                        
                        const tile = new MapTile(tileCoord, worldPos, tileScale);
                        tiles.set(tileKey, tile);
                        scene.add(tile.mesh);
                        tilesCreated++;
                        
                        loadPromises.push(tile.loadTexture(tileProvider, currentStyle));
                    }
                }
            }
            
            console.log(`🔨 创建了 ${tilesCreated} 个新瓦片`);
            
            if (loadPromises.length > 0) {
                console.log(`🔄 开始加载 ${loadPromises.length} 个瓦片纹理...`);
                try {
                    await Promise.all(loadPromises);
                    console.log('✅ 所有瓦片纹理加载完成');
                    updateStatus('瓦片加载完成', 'status');
                } catch (error) {
                    console.error('❌ 瓦片纹理加载失败:', error);
                    updateStatus('瓦片加载失败', 'error');
                }
            } else {
                updateStatus('没有新瓦片需要加载', 'warning');
            }
        }

        // 切换地图样式
        async function switchMapStyle(style) {
            console.log(`🎨 切换地图样式: ${style}`);
            currentStyle = style;
            updateStatus(`切换到${style}样式...`, 'warning');
            
            const tileProvider = new TileProvider();
            const reloadPromises = [];
            
            tiles.forEach((tile) => {
                reloadPromises.push(tile.loadTexture(tileProvider, style));
            });
            
            if (reloadPromises.length > 0) {
                try {
                    await Promise.all(reloadPromises);
                    updateStatus(`${style}样式加载完成`, 'status');
                } catch (error) {
                    updateStatus(`${style}样式加载失败`, 'error');
                }
            }
        }

        // 添加测试标记
        function addTestMarkers() {
            console.log('📌 添加测试项目标记...');
            
            const projects = [
                { name: '上海中心', pos: [0, 0, 0], color: 0x52c41a },
                { name: '测试项目A', pos: [5, 0, 5], color: 0xfaad14 },
                { name: '测试项目B', pos: [-5, 0, -5], color: 0x8c8c8c }
            ];
            
            projects.forEach(project => {
                const geometry = new THREE.CylinderGeometry(0.5, 0.75, 2, 16);
                const material = new THREE.MeshLambertMaterial({ 
                    color: project.color,
                    emissive: project.color,
                    emissiveIntensity: 0.2
                });
                
                const marker = new THREE.Mesh(geometry, material);
                marker.position.set(...project.pos);
                marker.position.y = 1;
                scene.add(marker);
                
                console.log(`✅ 添加标记: ${project.name}`);
            });
            
            updateStatus('测试标记已添加', 'status');
        }

        // 飞往上海
        function flyToShanghai() {
            console.log('✈️ 飞往上海中心...');
            camera.position.set(0, 20, 20);
            camera.lookAt(0, 0, 0);
            updateStatus('飞往上海中心', 'status');
        }

        // 重置视图
        function resetView() {
            console.log('🔄 重置视图...');
            camera.position.set(0, 25, 25);
            camera.lookAt(0, 0, 0);
            updateStatus('视图已重置', 'status');
        }

        // 更新状态显示
        function updateStatus(message, type = 'normal') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = type;
        }

        // 更新瓦片计数
        function updateTileCount() {
            let loadedCount = 0;
            tiles.forEach(tile => {
                if (tile.texture) loadedCount++;
            });
            document.getElementById('tile-count').textContent = loadedCount;
            document.getElementById('tile-status').textContent = `${loadedCount}/${tiles.size} 已加载`;
        }

        // 渲染循环
        function animate() {
            requestAnimationFrame(animate);
            
            // 计算FPS
            frameCount++;
            const currentTime = performance.now();
            if (currentTime - lastTime >= 1000) {
                const fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                document.getElementById('fps').textContent = fps;
                frameCount = 0;
                lastTime = currentTime;
            }
            
            // 更新相机位置显示
            const pos = camera.position;
            document.getElementById('camera-pos').textContent = 
                `(${pos.x.toFixed(1)}, ${pos.y.toFixed(1)}, ${pos.z.toFixed(1)})`;
            
            renderer.render(scene, camera);
        }

        // 窗口大小调整
        function handleResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // 鼠标控制
        function setupControls() {
            const canvas = renderer.domElement;
            let isDragging = false;
            let previousMousePosition = { x: 0, y: 0 };

            canvas.addEventListener('mousedown', (event) => {
                isDragging = true;
                previousMousePosition = { x: event.clientX, y: event.clientY };
            });

            canvas.addEventListener('mousemove', (event) => {
                if (!isDragging) return;
                
                const deltaMove = {
                    x: event.clientX - previousMousePosition.x,
                    y: event.clientY - previousMousePosition.y
                };
                
                camera.position.x -= deltaMove.x * 0.02;
                camera.position.z -= deltaMove.y * 0.02;
                
                previousMousePosition = { x: event.clientX, y: event.clientY };
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
            });

            canvas.addEventListener('wheel', (event) => {
                event.preventDefault();
                const zoomFactor = event.deltaY > 0 ? 1.1 : 0.9;
                camera.position.y *= zoomFactor;
                camera.position.y = Math.max(2, Math.min(50, camera.position.y));
            });
        }

        // 初始化应用
        async function init() {
            try {
                console.log('🚀 初始化geo-three测试应用...');
                updateStatus('初始化Three.js...', 'warning');
                
                initThreeJS();
                setupControls();
                
                // 延迟加载瓦片
                setTimeout(async () => {
                    await loadVisibleTiles();
                    animate();
                }, 500);
                
                window.addEventListener('resize', handleResize);
                
            } catch (error) {
                console.error('❌ 初始化失败:', error);
                updateStatus('初始化失败: ' + error.message, 'error');
            }
        }

        // 启动应用
        init();
    </script>
</body>
</html>