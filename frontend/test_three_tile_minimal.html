<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>three-tile 最小可工作示例</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #87CEEB; /* 天蓝色背景，便于对比 */
            font-family: Arial, sans-serif;
        }
        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 12px;
            line-height: 1.4;
        }
        .status {
            margin: 2px 0;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="info">
        <div class="status" id="status-init">🔄 初始化中...</div>
        <div class="status" id="status-source">📡 创建数据源...</div>
        <div class="status" id="status-map">🗺️ 创建地图...</div>
        <div class="status" id="status-render">🎨 开始渲染...</div>
        <div class="status" id="debug-info"></div>
    </div>

    <script type="module">
        // 导入必要的库
        import * as THREE from 'https://unpkg.com/three@0.171.0/build/three.module.js';
        import { OrbitControls } from 'https://unpkg.com/three@0.171.0/examples/jsm/controls/OrbitControls.js';
        
        // 由于无法直接从 CDN 导入 three-tile，我们使用本地的 node_modules 版本
        // 在实际项目中，应该从你的构建系统中导入
        console.log('🔄 开始 three-tile 最小示例测试...');
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = message;
            element.className = `status ${type}`;
        }
        
        function updateDebugInfo(info) {
            document.getElementById('debug-info').innerHTML = info;
        }
        
        async function initThreeTileTest() {
            try {
                updateStatus('status-init', '✅ Three.js 初始化完成', 'success');
                
                // 创建基础 Three.js 组件
                const scene = new THREE.Scene();
                const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
                const renderer = new THREE.WebGLRenderer({ 
                    antialias: true, 
                    alpha: true 
                });
                
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setClearColor(0x87CEEB, 1); // 天蓝色背景
                document.getElementById('container').appendChild(renderer.domElement);
                
                // 设置相机初始位置
                camera.position.set(0, 1000, 0);
                camera.lookAt(0, 0, 0);
                
                // 创建控制器
                const controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.minDistance = 10;
                controls.maxDistance = 5000;
                
                // 添加基础光照
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);
                directionalLight.position.set(100, 100, 50);
                scene.add(ambientLight);
                scene.add(directionalLight);
                
                updateStatus('status-init', '✅ Three.js 场景设置完成', 'success');
                
                // 由于无法直接测试 three-tile（需要构建环境），我们创建一个模拟的地图平面
                updateStatus('status-source', '⚠️ 使用模拟地图数据源（three-tile 需要构建环境）', 'warning');
                
                // 创建一个模拟的地图平面来展示应该如何显示
                const mapGeometry = new THREE.PlaneGeometry(2000, 2000, 50, 50);
                
                // 添加简单的高度变化
                const vertices = mapGeometry.attributes.position.array;
                for (let i = 0; i < vertices.length; i += 3) {
                    const x = vertices[i];
                    const y = vertices[i + 1];
                    vertices[i + 2] = Math.sin(x * 0.01) * Math.cos(y * 0.01) * 20;
                }
                mapGeometry.attributes.position.needsUpdate = true;
                mapGeometry.computeVertexNormals();
                
                // 创建地图材质（模拟瓦片纹理）
                const canvas = document.createElement('canvas');
                canvas.width = 512;
                canvas.height = 512;
                const context = canvas.getContext('2d');
                
                // 绘制模拟的地图瓦片
                context.fillStyle = '#4a90e2';
                context.fillRect(0, 0, 512, 512);
                
                // 添加网格线模拟街道
                context.strokeStyle = '#ffffff';
                context.lineWidth = 2;
                for (let i = 0; i < 512; i += 64) {
                    context.beginPath();
                    context.moveTo(i, 0);
                    context.lineTo(i, 512);
                    context.stroke();
                    
                    context.beginPath();
                    context.moveTo(0, i);
                    context.lineTo(512, i);
                    context.stroke();
                }
                
                const mapTexture = new THREE.CanvasTexture(canvas);
                const mapMaterial = new THREE.MeshLambertMaterial({
                    map: mapTexture,
                    transparent: false
                });
                
                const mapMesh = new THREE.Mesh(mapGeometry, mapMaterial);
                mapMesh.rotation.x = -Math.PI / 2; // 使平面水平
                mapMesh.name = 'mock-tile-map';
                
                scene.add(mapMesh);
                updateStatus('status-map', '✅ 模拟地图创建完成', 'success');
                
                // 添加一些标记点模拟项目位置
                const markerGeometry = new THREE.ConeGeometry(20, 60, 8);
                const markerMaterial = new THREE.MeshLambertMaterial({ color: 0xff4444 });
                
                const positions = [
                    { x: 200, z: 200, name: '上海项目' },
                    { x: -300, z: 100, name: '北京项目' },
                    { x: 100, z: -400, name: '深圳项目' }
                ];
                
                positions.forEach(pos => {
                    const marker = new THREE.Mesh(markerGeometry, markerMaterial);
                    marker.position.set(pos.x, 30, pos.z);
                    scene.add(marker);
                });
                
                updateStatus('status-render', '✅ 开始渲染循环', 'success');
                
                // 渲染循环
                let frameCount = 0;
                function animate() {
                    requestAnimationFrame(animate);
                    
                    controls.update();
                    camera.updateMatrixWorld();
                    
                    renderer.render(scene, camera);
                    
                    // 每60帧更新一次调试信息
                    if (frameCount % 60 === 0) {
                        updateDebugInfo(`
                            📊 渲染统计: ${frameCount} 帧<br>
                            📹 相机位置: (${camera.position.x.toFixed(1)}, ${camera.position.y.toFixed(1)}, ${camera.position.z.toFixed(1)})<br>
                            🔺 场景对象: ${scene.children.length} 个<br>
                            💡 状态: 正常运行中
                        `);
                    }
                    frameCount++;
                }
                
                animate();
                
                // 窗口大小调整
                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });
                
                console.log('✅ three-tile 最小示例测试完成！');
                console.log('📝 使用说明:');
                console.log('  - 鼠标左键拖拽：旋转视角');
                console.log('  - 鼠标滚轮：缩放');
                console.log('  - 鼠标右键拖拽：平移');
                console.log('  - 如果你看到了网格状的蓝色地面和红色标记，说明基础渲染正常');
                console.log('  - 在实际项目中，这个模拟地面应该被 three-tile 的真实地图瓦片替代');
                
            } catch (error) {
                console.error('❌ 初始化失败:', error);
                updateStatus('status-init', `❌ 初始化失败: ${error.message}`, 'error');
            }
        }
        
        // 启动测试
        initThreeTileTest();
        
    </script>
</body>
</html>