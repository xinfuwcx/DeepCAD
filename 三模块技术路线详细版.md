# DeepCAD 三模块技术路线详细版
**更新日期**: 2025-01-22  
**分析类型**: 固体力学 + 渗流分析

---

## 🔧 **模块一：网格模块 (Meshing)**

### 🎯 **模块职责**
- GMSH网格划分 + Fragment土体切割 + 质量分析
- 为固体力学和渗流分析提供高质量网格

### 📊 **当前状态：90% 完成**
- ✅ GMSH 4.14.0 完全集成
- ✅ Fragment土体切割验证通过
- ✅ 6种质量指标分析
- ⚠️ 需要集成Fragment到API

### 🚀 **技术路线 (3天)**

#### **Day 1: Fragment API集成**
```python
class SoilDomainFragmentConfig:
    """土体域切割配置"""
    enable_fragment: bool = False
    
    # 开挖区域定义
    excavation_zones: List[Dict] = [
        {
            "type": "box",  # box, cylinder, custom_shape
            "geometry": {"x": 0, "y": 0, "z": 0, "width": 10, "length": 8, "depth": 5},
            "material_remove": True,  # 是否移除材料（开挖）
            "physical_group": "excavation_1"
        }
    ]
    
    # 桩基础定义
    pile_foundations: List[Dict] = [
        {
            "type": "cylinder",
            "geometry": {"x": 2, "y": 2, "center_z": 0, "radius": 0.5, "height": 15},
            "material_type": "concrete",
            "physical_group": "pile_concrete"
        }
    ]
    
    # 支护结构定义  
    support_structures: List[Dict] = [
        {
            "type": "wall",  # wall, beam, anchor
            "geometry": {"start": [0,0,0], "end": [10,0,0], "thickness": 0.8, "height": 8},
            "material_type": "concrete",
            "physical_group": "diaphragm_wall"
        }
    ]
    
    # 渗流层定义
    seepage_layers: List[Dict] = [
        {
            "layer_name": "clay_layer",
            "z_top": -5,
            "z_bottom": -15, 
            "permeability": 1e-9,  # m/s
            "physical_group": "clay_seepage"
        }
    ]
    
    auto_physical_groups: bool = True
```

#### **Day 2: 渗流网格特殊处理**
```python
class SeepageNetGeneration:
    """渗流分析专用网格生成"""
    
    def generate_seepage_compatible_mesh(self):
        """生成渗流分析兼容的网格"""
        # 1. 确保水位线附近网格加密
        self.refine_water_table_region()
        
        # 2. 渗流边界处理
        self.create_seepage_boundaries()
        
        # 3. 不同渗透性土层界面处理
        self.handle_permeability_interfaces()
    
    def refine_water_table_region(self):
        """地下水位线区域网格加密"""
        # 在地下水位上下1m范围内加密网格
        pass
    
    def create_seepage_boundaries(self):
        """创建渗流边界"""
        # 不透水边界、定水头边界、排水边界
        pass
```

#### **Day 3: 固体力学网格优化**
```python
class StructuralMeshOptimization:
    """结构分析网格优化"""
    
    def optimize_for_structural_analysis(self):
        """针对结构分析优化网格"""
        # 1. 应力集中区域加密
        self.refine_stress_concentration_areas()
        
        # 2. 接触面网格匹配
        self.match_interface_meshes()
        
        # 3. 结构单元类型选择
        self.select_element_types()
    
    def refine_stress_concentration_areas(self):
        """应力集中区域加密"""
        # 支护结构连接处、角点等区域
        pass
```

---

## ⚖️ **模块二：计算模块 (Analysis)**

### 🎯 **模块职责** 
- 固体力学前处理 + 渗流分析前处理 + Kratos求解
- 支持耦合分析（固体变形影响渗流，渗流压力影响固体）

### 📊 **当前状态：60% 完成**
- ✅ Kratos 10.3.0 (结构力学+地质力学)
- ✅ 计算引擎框架
- ❌ 前处理界面缺失

### 🚀 **技术路线 (7天)**

#### **Day 1-2: 固体力学前处理**
```python
class StructuralAnalysisSetup:
    """固体力学分析设置"""
    
    # 荷载系统
    class LoadManager:
        def add_excavation_unloading(self, excavation_zone, unloading_steps):
            """开挖卸荷荷载"""
            # 模拟分步开挖的卸荷过程
            pass
            
        def add_surcharge_load(self, surface_area, load_value):
            """地面超载"""
            # 建筑物荷载、交通荷载等
            pass
            
        def add_construction_load(self, support_elements, load_stages):
            """施工荷载"""
            # 支护结构自重、施工临时荷载
            pass
    
    # 约束系统
    class ConstraintManager:
        def set_excavation_boundary(self, excavation_surface):
            """开挖面约束（自由面）"""
            pass
            
        def set_ground_support(self, wall_elements, support_type):
            """支护约束"""
            # 挡土墙、锚杆、内撑等约束
            pass
            
        def set_foundation_constraint(self, foundation_base):
            """地基约束"""
            pass
    
    # 材料模型
    class SoilMaterialManager:
        def assign_mohr_coulomb(self, soil_volume, cohesion, friction_angle, 
                               elastic_modulus, poisson_ratio):
            """摩尔-库仑土体材料"""
            pass
            
        def assign_hardening_soil(self, soil_volume, soil_params):
            """硬化土模型"""
            pass
            
        def assign_concrete_material(self, structure_volume, concrete_grade):
            """混凝土材料"""
            pass
```

#### **Day 3-4: 渗流分析前处理**
```python
class SeepageAnalysisSetup:
    """渗流分析设置"""
    
    # 边界条件
    class SeepageBoundaryManager:
        def set_constant_head_boundary(self, boundary_surface, head_value):
            """定水头边界"""
            # 河流、湖泊等恒定水位
            pass
            
        def set_impermeable_boundary(self, boundary_surface):
            """不透水边界"""
            # 不透水岩层、防渗墙等
            pass
            
        def set_seepage_face_boundary(self, boundary_surface):
            """渗出面边界"""
            # 基坑侧壁渗水面
            pass
            
        def set_drainage_boundary(self, boundary_surface, drainage_capacity):
            """排水边界"""
            # 降水井、排水系统
            pass
    
    # 渗透参数
    class PermeabilityManager:
        def set_isotropic_permeability(self, soil_volume, k_value):
            """各向同性渗透系数"""
            pass
            
        def set_anisotropic_permeability(self, soil_volume, kx, ky, kz):
            """各向异性渗透系数"""
            # 层状土体的渗透各向异性
            pass
            
        def set_variable_permeability(self, soil_volume, permeability_function):
            """变渗透系数"""
            # 与应力状态相关的渗透系数变化
            pass
    
    # 初始条件
    class InitialConditionManager:
        def set_initial_water_table(self, water_table_surface):
            """初始地下水位"""
            pass
            
        def set_initial_pore_pressure(self, volume, pressure_distribution):
            """初始孔隙水压力"""
            pass
```

#### **Day 5-6: 耦合分析设置**
```python
class CoupledAnalysisSetup:
    """固体-渗流耦合分析"""
    
    def setup_consolidation_analysis(self):
        """固结分析设置"""
        # Biot固结理论
        # 考虑土体变形对渗流场的影响
        pass
    
    def setup_excavation_dewatering(self):
        """开挖降水耦合分析"""
        # 降水引起的有效应力变化
        # 开挖卸荷与渗流场变化的耦合
        pass
    
    def configure_time_stepping(self):
        """时间步长配置"""
        # 渗流分析：较大时间步长（小时、天）
        # 结构分析：较小时间步长（分钟、小时）
        pass
```

#### **Day 7: Kratos求解器配置**
```python
class KratosSolverConfiguration:
    """Kratos求解器配置"""
    
    def configure_structural_solver(self):
        """结构分析求解器"""
        # Newton-Raphson非线性求解
        # 自适应时间步长
        pass
    
    def configure_seepage_solver(self):
        """渗流分析求解器"""  
        # 稳态/瞬态渗流求解
        # 自由面迭代算法
        pass
    
    def configure_coupled_solver(self):
        """耦合分析求解器"""
        # 分离式求解策略
        # 收敛性控制
        pass
```

---

## 🎨 **模块三：可视化模块 (Visualization)**

### 🎯 **模块职责**
- PyVista显示网格、约束、荷载、固体力学结果、渗流结果
- 针对固体和渗流的不同可视化需求

### 📊 **当前状态：40% 完成**
- ✅ PyVista框架存在
- ✅ 约束荷载显示能力验证
- ❌ 具体实现缺失

### 🚀 **技术路线 (5天)**

#### **Day 1: 网格与前处理可视化**
```python
class MeshVisualization:
    """网格可视化增强"""
    
    def show_fragmented_mesh(self, mesh_data, physical_groups):
        """显示切割后的网格"""
        # 不同物理群组用不同颜色
        # 土体、开挖、支护结构分色显示
        pass
    
    def show_mesh_quality_analysis(self, quality_results):
        """网格质量可视化"""
        # 质量云图、问题单元高亮
        pass

class PreprocessingVisualization:
    """前处理可视化"""
    
    # 固体力学可视化
    def show_structural_loads(self, loads_data):
        """显示结构荷载"""
        # 开挖卸荷：红色向上箭头
        # 超载：蓝色向下箭头  
        # 施工荷载：绿色箭头
        pass
    
    def show_structural_constraints(self, constraints_data):
        """显示结构约束"""
        # 固定约束：红色三角形
        # 支护约束：蓝色矩形
        # 弹性支撑：绿色弹簧符号
        pass
    
    # 渗流分析可视化
    def show_seepage_boundaries(self, boundary_conditions):
        """显示渗流边界条件"""
        # 定水头边界：蓝色波浪线
        # 不透水边界：黑色实线
        # 渗出面：橙色虚线
        # 排水边界：绿色点线
        pass
    
    def show_permeability_zones(self, permeability_data):
        """显示渗透性分区"""
        # 用颜色深浅表示渗透系数大小
        # 高渗透：蓝色，低渗透：红色
        pass
```

#### **Day 2: 固体力学结果可视化**
```python
class StructuralResultsVisualization:
    """固体力学结果可视化"""
    
    def show_displacement_contours(self, displacement_results):
        """位移云图"""
        # 总位移、水平位移、竖向位移
        # 变形动画（放大显示）
        pass
    
    def show_stress_contours(self, stress_results):
        """应力云图"""
        # von Mises应力
        # 主应力方向（张量可视化）
        # 剪应力分布
        pass
    
    def show_strain_analysis(self, strain_results):
        """应变分析"""
        # 体应变、剪应变
        # 塑性应变区域标识
        pass
    
    def show_excavation_influence(self, excavation_results):
        """开挖影响分析"""
        # 开挖引起的地表沉降
        # 支护结构受力状态
        # 影响范围等值线
        pass
    
    def create_construction_sequence_animation(self, time_series_results):
        """施工过程动画"""
        # 分步开挖过程
        # 支护结构安装过程
        # 应力重分布过程
        pass
```

#### **Day 3: 渗流结果可视化**
```python
class SeepageResultsVisualization:
    """渗流结果可视化"""
    
    def show_hydraulic_head_contours(self, head_results):
        """水头等值线"""
        # 总水头、压力水头、位置水头
        # 地下水位线标识
        pass
    
    def show_pore_pressure_distribution(self, pressure_results):
        """孔隙水压力分布"""
        # 正孔压：蓝色，负孔压：红色
        # 超孔压消散过程动画
        pass
    
    def show_seepage_velocity_field(self, velocity_results):
        """渗流速度场"""
        # 流线显示
        # 速度矢量场（箭头）
        # 流量大小用箭头长度表示
        pass
    
    def show_seepage_flow_analysis(self, flow_results):
        """渗流量分析"""
        # 总渗流量统计
        # 各边界渗流量
        # 基坑涌水量计算
        pass
    
    def show_drainage_effectiveness(self, drainage_results):
        """降水效果分析"""
        # 降水井影响范围
        # 降水漏斗曲线
        # 降水效果评估
        pass
    
    def create_seepage_evolution_animation(self, time_series_seepage):
        """渗流演化动画"""
        # 地下水位变化过程
        # 孔压消散过程  
        # 渗流场演化
        pass
```

#### **Day 4: 耦合结果可视化**
```python
class CoupledResultsVisualization:
    """耦合分析结果可视化"""
    
    def show_consolidation_results(self, consolidation_data):
        """固结分析结果"""
        # 固结度发展曲线
        # 沉降-时间曲线
        # 有效应力变化
        pass
    
    def show_effective_stress_analysis(self, stress_results, pore_pressure):
        """有效应力分析"""
        # 总应力 = 有效应力 + 孔压
        # 有效应力路径
        # 破坏准则检查
        pass
    
    def show_dewatering_induced_settlement(self, settlement_results):
        """降水引起的地面沉降"""
        # 沉降云图
        # 沉降影响范围
        # 建筑物沉降风险评估
        pass
    
    def show_excavation_stability_analysis(self, stability_results):
        """开挖稳定性分析"""
        # 安全系数分布
        # 潜在滑移面
        # 支护结构效果评价
        pass
```

#### **Day 5: 界面集成和交互优化**
```python
class VisualizationUIIntegration:
    """可视化界面集成"""
    
    def create_results_dashboard(self):
        """结果仪表盘"""
        # 多视窗显示：固体结果 + 渗流结果
        # 实时数据监控
        # 关键参数警报系统
        pass
    
    def implement_interactive_controls(self):
        """交互控制"""
        # 时间步长滑块
        # 结果类型切换
        # 剖面切割工具
        # 数据导出功能
        pass
    
    def optimize_web_performance(self):
        """Web性能优化"""
        # 大数据集分块加载
        # LOD（细节层次）显示
        # WebGL渲染优化
        pass
```

---

## 📊 **三模块协同工作流**

### 🔄 **标准分析流程**
```
1. 网格模块: 土体域 → Fragment切割 → 高质量网格 → 物理群组
2. 计算模块: 荷载设置 → 边界条件 → 材料参数 → Kratos求解
3. 可视化模块: 实时监控 → 结果云图 → 动画演示 → 报告生成
```

### 🎯 **里程碑验证案例**

#### **基坑开挖案例** (综合验证)
- **网格**: 15m×10m×8m基坑，Fragment切割，4层土体
- **固体**: 分5步开挖，支护结构，地表超载
- **渗流**: 初始水位-3m，基坑降水，渗流分析
- **可视化**: 开挖过程动画，沉降云图，渗流场演化

#### **桩基础案例** (渗流重点)
- **网格**: 直径1m，长度20m桩基，Fragment处理
- **渗流**: 打桩扰动，孔压消散，长期渗流
- **固体**: 桩土相互作用，承载力分析
- **可视化**: 孔压消散动画，承载力发展

---

**总结**: 18天完成三模块全功能开发，重点突出固体力学和渗流的不同特点及其耦合分析能力。