# æ–½å·¥æ­¥åºå®šä¹‰æ–¹æ¡ˆ
**æ ¸å¿ƒé—®é¢˜**: æ–½å·¥æ­¥åºåœ¨å“ªä¸ªæ¨¡å—å®šä¹‰ï¼Ÿå¦‚ä½•ä¸å¯è§†åŒ–æ¨¡å—åä½œï¼Ÿ

---

## ğŸ—ï¸ **æ–½å·¥æ­¥åºå®šä¹‰ä½ç½®**

### **ä¸»è¦å®šä¹‰ä½ç½®ï¼šè®¡ç®—æ¨¡å— (Analysis Module)**
```
è®¡ç®—æ¨¡å—å‰å¤„ç† â†’ å®šä¹‰æ–½å·¥æ­¥åº â†’ Kratosæ±‚è§£ â†’ å¯è§†åŒ–æ¨¡å—å±•ç¤ºåŠ¨ç”»
```

### **æ–½å·¥æ­¥åºæ•°æ®æµ**
```
1. ç”¨æˆ·åœ¨è®¡ç®—æ¨¡å—ç•Œé¢å®šä¹‰æ–½å·¥æ­¥åº
2. è®¡ç®—æ¨¡å—å°†æ­¥åºé…ç½®ä¼ é€’ç»™Kratos
3. KratosæŒ‰æ­¥åºè¿›è¡Œè®¡ç®—ï¼Œè¾“å‡ºæ¯æ­¥ç»“æœ
4. å¯è§†åŒ–æ¨¡å—è¯»å–å¤šæ­¥ç»“æœï¼Œç”Ÿæˆæ–½å·¥è¿‡ç¨‹åŠ¨ç”»
```

---

## ğŸ›ï¸ **æ–½å·¥æ­¥åºå®šä¹‰ç•Œé¢è®¾è®¡**

### **åœ¨è®¡ç®—æ¨¡å—ä¸­å¢åŠ "æ–½å·¥åºåˆ—"é…ç½®é¢æ¿**

#### **åŸºå‘å¼€æŒ–æ–½å·¥æ­¥åºç¤ºä¾‹**
```tsx
interface ConstructionStep {
  step_id: number;
  step_name: string;
  step_type: 'excavation' | 'support_install' | 'load_apply' | 'dewatering';
  duration: number;  // æ–½å·¥å‘¨æœŸï¼ˆå¤©ï¼‰
  geometry_changes?: any;  // å‡ ä½•å˜åŒ–
  load_changes?: any;      // è·è½½å˜åŒ–
  boundary_changes?: any;  // è¾¹ç•Œæ¡ä»¶å˜åŒ–
  description: string;
}

// æ–½å·¥æ­¥åºé…ç½®ç»„ä»¶
const ConstructionSequencePanel = () => {
  const [constructionSteps, setConstructionSteps] = useState<ConstructionStep[]>([
    {
      step_id: 1,
      step_name: "ç¬¬ä¸€å±‚å¼€æŒ–",
      step_type: "excavation",
      duration: 3,
      geometry_changes: {
        remove_volumes: ["excavation_layer_1"],
        excavation_depth: -2.0
      },
      description: "å¼€æŒ–è‡³-2mæ ‡é«˜"
    },
    {
      step_id: 2, 
      step_name: "ç¬¬ä¸€é“æ”¯æ’‘å®‰è£…",
      step_type: "support_install",
      duration: 2,
      geometry_changes: {
        add_elements: ["horizontal_strut_1"],
        support_stiffness: 2e8
      },
      description: "å®‰è£…ç¬¬ä¸€é“æ°´å¹³æ”¯æ’‘"
    },
    {
      step_id: 3,
      step_name: "ç¬¬äºŒå±‚å¼€æŒ–", 
      step_type: "excavation",
      duration: 4,
      geometry_changes: {
        remove_volumes: ["excavation_layer_2"],
        excavation_depth: -4.5
      },
      description: "å¼€æŒ–è‡³-4.5mæ ‡é«˜"
    },
    {
      step_id: 4,
      step_name: "é™æ°´å¼€å§‹",
      step_type: "dewatering", 
      duration: 1,
      boundary_changes: {
        add_drainage_boundary: ["dewatering_wells"],
        target_water_level: -6.0
      },
      description: "å¯åŠ¨é™æ°´äº•ï¼Œæ°´ä½é™è‡³-6m"
    }
  ]);

  return (
    <Card title="æ–½å·¥æ­¥åºå®šä¹‰" size="small">
      <div style={{ marginBottom: 16 }}>
        <Button 
          type="dashed" 
          icon={<PlusOutlined />}
          onClick={() => addConstructionStep()}
          block
        >
          æ·»åŠ æ–½å·¥æ­¥
        </Button>
      </div>

      <List
        dataSource={constructionSteps}
        renderItem={(step, index) => (
          <List.Item>
            <Card 
              size="small" 
              title={`æ­¥éª¤${step.step_id}: ${step.step_name}`}
              extra={
                <Space>
                  <Button size="small" icon={<EditOutlined />} />
                  <Button size="small" icon={<DeleteOutlined />} danger />
                </Space>
              }
            >
              <Row gutter={16}>
                <Col span={6}>
                  <Text strong>ç±»å‹:</Text>
                  <br />
                  <Tag color={getStepTypeColor(step.step_type)}>
                    {getStepTypeName(step.step_type)}
                  </Tag>
                </Col>
                <Col span={6}>
                  <Text strong>å·¥æœŸ:</Text>
                  <br />
                  <Text>{step.duration} å¤©</Text>
                </Col>
                <Col span={12}>
                  <Text strong>æè¿°:</Text>
                  <br />
                  <Text type="secondary">{step.description}</Text>
                </Col>
              </Row>
            </Card>
          </List.Item>
        )}
      />

      <Divider />
      
      <Space>
        <Button type="primary" icon={<PlayCircleOutlined />}>
          é¢„è§ˆæ–½å·¥åºåˆ—
        </Button>
        <Button icon={<SaveOutlined />}>
          ä¿å­˜é…ç½®
        </Button>
        <Button icon={<ImportOutlined />}>
          å¯¼å…¥æ¨¡æ¿
        </Button>
      </Space>
    </Card>
  );
};
```

---

## ğŸ“ **è®¡ç®—æ¨¡å—ä¸­çš„æ–½å·¥æ­¥åºç®¡ç†**

### **åœ¨è®¡ç®—æ¨¡å—è·¯ç”±ä¸­å¢åŠ æ–½å·¥æ­¥åºAPI**

```python
# gateway/modules/computation/construction_sequence.py

from fastapi import APIRouter, HTTPException
from typing import List, Dict, Any
from pydantic import BaseModel

router = APIRouter(prefix="/computation/construction-sequence")

class ConstructionStep(BaseModel):
    step_id: int
    step_name: str
    step_type: str  # excavation, support_install, load_apply, dewatering
    duration: float
    geometry_changes: Dict[str, Any] = {}
    load_changes: Dict[str, Any] = {}
    boundary_changes: Dict[str, Any] = {}
    description: str

class ConstructionSequence(BaseModel):
    project_id: str
    sequence_name: str
    total_steps: int
    total_duration: float
    steps: List[ConstructionStep]

@router.post("/create")
async def create_construction_sequence(sequence: ConstructionSequence):
    """åˆ›å»ºæ–½å·¥æ­¥åºé…ç½®"""
    try:
        # éªŒè¯æ­¥åºé€»è¾‘åˆç†æ€§
        validate_construction_sequence(sequence)
        
        # ä¿å­˜åˆ°æ•°æ®åº“
        sequence_id = save_construction_sequence(sequence)
        
        return {
            "success": True,
            "sequence_id": sequence_id,
            "message": f"æ–½å·¥æ­¥åº'{sequence.sequence_name}'åˆ›å»ºæˆåŠŸ"
        }
        
    except Exception as e:
        raise HTTPException(status_code=400, detail=str(e))

@router.get("/templates")
async def get_construction_templates():
    """è·å–æ–½å·¥æ­¥åºæ¨¡æ¿"""
    templates = {
        "åŸºå‘å¼€æŒ–": {
            "description": "æ ‡å‡†åŸºå‘åˆ†å±‚å¼€æŒ–+æ”¯æ’‘å®‰è£…",
            "typical_steps": [
                "ç¬¬ä¸€å±‚å¼€æŒ– â†’ ç¬¬ä¸€é“æ”¯æ’‘ â†’ ç¬¬äºŒå±‚å¼€æŒ– â†’ ç¬¬äºŒé“æ”¯æ’‘ â†’ åº•æ¿å¼€æŒ–"
            ],
            "duration": "15-25å¤©"
        },
        "æ¡©åŸºæ–½å·¥": {
            "description": "é’»å­”çŒæ³¨æ¡©æ–½å·¥åºåˆ—", 
            "typical_steps": [
                "é’»å­” â†’ æ¸…å­” â†’ ä¸‹é’¢ç­‹ç¬¼ â†’ çŒæ³¨æ··å‡åœŸ â†’ å…»æŠ¤"
            ],
            "duration": "2-3å¤©/æ¡©"
        },
        "é™æ°´å·¥ç¨‹": {
            "description": "åŸºå‘é™æ°´æ–½å·¥åºåˆ—",
            "typical_steps": [
                "é™æ°´äº•æ–½å·¥ â†’ è¯•æŠ½æ°´ â†’ æ­£å¼é™æ°´ â†’ æ°´ä½ç›‘æµ‹"
            ],
            "duration": "7-10å¤©"
        }
    }
    return {"templates": templates}

@router.post("/analyze")
async def analyze_construction_sequence(
    sequence_id: str,
    analysis_config: Dict[str, Any]
):
    """æ‰§è¡Œåˆ†æ­¥æ–½å·¥åˆ†æ"""
    try:
        # è·å–æ–½å·¥æ­¥åºé…ç½®
        sequence = get_construction_sequence(sequence_id)
        
        # åˆå§‹åŒ–Kratosåˆ†æ
        kratos_manager = get_kratos_manager()
        
        # åˆ†æ­¥æ‰§è¡Œåˆ†æ
        step_results = []
        for step in sequence.steps:
            # æ ¹æ®æ­¥åºç±»å‹é…ç½®åˆ†æå‚æ•°
            step_config = configure_analysis_for_step(step, analysis_config)
            
            # æ‰§è¡Œå•æ­¥åˆ†æ
            step_result = await kratos_manager.run_step_analysis(step_config)
            step_results.append(step_result)
            
            # æ›´æ–°å‡ ä½•å’Œè¾¹ç•Œæ¡ä»¶ä¸ºä¸‹ä¸€æ­¥åšå‡†å¤‡
            update_model_for_next_step(step)
        
        return {
            "success": True,
            "step_results": step_results,
            "message": "åˆ†æ­¥æ–½å·¥åˆ†æå®Œæˆ"
        }
        
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

def configure_analysis_for_step(step: ConstructionStep, base_config: Dict):
    """æ ¹æ®æ–½å·¥æ­¥ç±»å‹é…ç½®åˆ†æå‚æ•°"""
    step_config = base_config.copy()
    
    if step.step_type == "excavation":
        # å¼€æŒ–æ­¥ï¼šç§»é™¤å•å…ƒï¼Œæ›´æ–°è·è½½
        step_config.update({
            "remove_elements": step.geometry_changes.get("remove_volumes", []),
            "unloading_factor": 1.0,  # å®Œå…¨å¸è·
            "analysis_type": "nonlinear_static"
        })
        
    elif step.step_type == "support_install":
        # æ”¯æ’‘å®‰è£…ï¼šæ·»åŠ å•å…ƒï¼Œæ–½åŠ é¢„åº”åŠ›
        step_config.update({
            "add_elements": step.geometry_changes.get("add_elements", []),
            "prestress": step.geometry_changes.get("prestress", 0),
            "analysis_type": "static_with_prestress"
        })
        
    elif step.step_type == "dewatering":
        # é™æ°´æ­¥ï¼šä¿®æ”¹è¾¹ç•Œæ¡ä»¶ï¼Œè€¦åˆåˆ†æ
        step_config.update({
            "boundary_conditions": step.boundary_changes,
            "target_water_level": step.boundary_changes.get("target_water_level"),
            "analysis_type": "coupled_seepage_structural"
        })
    
    return step_config
```

---

## ğŸ¬ **å¯è§†åŒ–æ¨¡å—ä¸­çš„æ–½å·¥åŠ¨ç”»**

### **åœ¨å¯è§†åŒ–æ¨¡å—ä¸­è¯»å–æ–½å·¥æ­¥åºç»“æœ**

```tsx
// åœ¨PostProcessingPanelä¸­å¢åŠ æ–½å·¥åŠ¨ç”»æ§åˆ¶
const renderConstructionAnimation = () => (
  <Space direction="vertical" style={{ width: '100%' }}>
    <div>
      <Text strong>æ–½å·¥æ­¥åºåŠ¨ç”»:</Text>
    </div>
    
    {/* æ–½å·¥æ­¥åºé€‰æ‹© */}
    <Select 
      value={selectedSequence}
      onChange={setSelectedSequence}
      placeholder="é€‰æ‹©æ–½å·¥æ­¥åº"
      style={{ width: '100%' }}
    >
      {availableSequences.map(seq => (
        <Option key={seq.id} value={seq.id}>
          {seq.name} ({seq.total_steps}æ­¥)
        </Option>
      ))}
    </Select>

    {/* å½“å‰æ–½å·¥æ­¥æ˜¾ç¤º */}
    {currentConstructionStep && (
      <Card size="small" style={{ backgroundColor: '#f6ffed' }}>
        <Text strong>å½“å‰æ­¥éª¤: </Text>
        <Tag color="blue">æ­¥éª¤{currentConstructionStep.step_id}</Tag>
        <br />
        <Text>{currentConstructionStep.step_name}</Text>
        <br />
        <Text type="secondary">{currentConstructionStep.description}</Text>
      </Card>
    )}

    {/* æ—¶é—´è½´æ§åˆ¶ */}
    <div>
      <Text>æ–½å·¥è¿›åº¦: ç¬¬{currentDay}å¤© / å…±{totalDays}å¤©</Text>
      <Slider
        min={0}
        max={totalDays}
        value={currentDay}
        onChange={setCurrentDay}
        tooltip={{ 
          formatter: (value) => `ç¬¬${value}å¤©: ${getCurrentStepName(value)}` 
        }}
      />
    </div>

    {/* æ’­æ”¾æ§åˆ¶ */}
    <Row gutter={8}>
      <Col span={8}>
        <Button
          icon={constructionAnimation.playing ? <PauseOutlined /> : <PlayCircleOutlined />}
          onClick={toggleConstructionAnimation}
          block
          size="small"
        >
          {constructionAnimation.playing ? 'æš‚åœ' : 'æ’­æ”¾'}
        </Button>
      </Col>
      <Col span={8}>
        <Button
          icon={<StepForwardOutlined />}
          onClick={nextConstructionStep}
          block
          size="small"
        >
          ä¸‹ä¸€æ­¥
        </Button>
      </Col>
      <Col span={8}>
        <Button
          icon={<ReloadOutlined />}
          onClick={resetConstructionAnimation}
          block
          size="small"
        >
          é‡ç½®
        </Button>
      </Col>
    </Row>

    {/* æ–½å·¥æ­¥åºæ—¶é—´çº¿ */}
    <div>
      <Text strong>æ–½å·¥æ—¶é—´çº¿:</Text>
      <Timeline size="small" style={{ marginTop: 8 }}>
        {constructionSteps.map((step, index) => (
          <Timeline.Item 
            key={step.step_id}
            color={index === currentStepIndex ? 'blue' : 'gray'}
            dot={index === currentStepIndex ? <PlayCircleOutlined /> : undefined}
          >
            <Text strong={index === currentStepIndex}>
              {step.step_name}
            </Text>
            <br />
            <Text type="secondary">
              ç¬¬{getStepStartDay(step)}~{getStepEndDay(step)}å¤©
            </Text>
          </Timeline.Item>
        ))}
      </Timeline>
    </div>
  </Space>
);

// åœ¨ä¸»Tabsä¸­å¢åŠ æ–½å·¥åŠ¨ç”»Tab
<TabPane tab={<span><BuildOutlined />æ–½å·¥</span>} key="construction">
  {renderConstructionAnimation()}
</TabPane>
```

---

## ğŸ”„ **æ•°æ®æµç¨‹å›¾**

```
ç”¨æˆ·ç•Œé¢ (è®¡ç®—æ¨¡å—)
    â†“
å®šä¹‰æ–½å·¥æ­¥åº (ConstructionSequencePanel)
    â†“  
ä¿å­˜åˆ°æ•°æ®åº“ (construction_sequence.py)
    â†“
Kratosåˆ†æ­¥è®¡ç®— (kratos_handler.py)
    â†“
ç”Ÿæˆæ¯æ­¥ç»“æœæ–‡ä»¶ (step_1.vtk, step_2.vtk, ...)
    â†“
å¯è§†åŒ–æ¨¡å—è¯»å– (PyVistaViewer)
    â†“
ç”Ÿæˆæ–½å·¥è¿‡ç¨‹åŠ¨ç”» (PostProcessingPanel)
    â†“
ç”¨æˆ·æŸ¥çœ‹æ–½å·¥æ¨¡æ‹Ÿ
```

---

## ğŸ“‹ **æ€»ç»“**

**æ–½å·¥æ­¥åºå®šä¹‰ä½ç½®**: 
- **ä¸»è¦ä½ç½®**: è®¡ç®—æ¨¡å—çš„å‰å¤„ç†é˜¶æ®µ
- **é…ç½®ç•Œé¢**: ConstructionSequencePanel 
- **APIæ¥å£**: `/computation/construction-sequence/*`
- **å¯è§†åŒ–**: PostProcessingPanelä¸­çš„æ–½å·¥åŠ¨ç”»Tab

**ä¼˜åŠ¿**:
- æ–½å·¥æ­¥åºä¸åˆ†æé€»è¾‘ç´§å¯†ç»“åˆ
- å¯ä»¥é¢„è®¾å¸¸ç”¨æ–½å·¥æ¨¡æ¿
- æ”¯æŒå¤æ‚çš„å‡ ä½•å’Œè¾¹ç•Œæ¡ä»¶å˜åŒ–
- ä¸ç°æœ‰å¯è§†åŒ–æ¨¡å—æ— ç¼é›†æˆ

ä½ è§‰å¾—è¿™ä¸ªæ–½å·¥æ­¥åºå®šä¹‰æ–¹æ¡ˆå¦‚ä½•ï¼Ÿ