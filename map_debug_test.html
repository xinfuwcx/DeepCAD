<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地图加载诊断测试</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        .test-container {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #333;
            border-radius: 8px;
            background: #2a2a2a;
        }
        .map-container {
            width: 100%;
            height: 300px;
            border: 1px solid #555;
            margin-top: 10px;
            position: relative;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.loading { background: #2196F3; }
        .status.success { background: #4CAF50; }
        .status.error { background: #f44336; }
        .test-button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover { background: #1976D2; }
    </style>
</head>
<body>
    <h1>🗺️ DeepCAD 地图加载诊断工具</h1>
    
    <!-- 测试1: 高德地图 -->
    <div class="test-container">
        <h2>测试1: 高德地图API</h2>
        <button class="test-button" onclick="testAMap()">🧪 测试高德地图</button>
        <div id="amap-status" class="status">等待测试...</div>
        <div id="amap-container" class="map-container"></div>
    </div>
    
    <!-- 测试2: OpenStreetMap -->
    <div class="test-container">
        <h2>测试2: OpenStreetMap (备用方案)</h2>
        <button class="test-button" onclick="testOSM()">🧪 测试OSM地图</button>
        <div id="osm-status" class="status">等待测试...</div>
        <div id="osm-container" class="map-container"></div>
    </div>
    
    <!-- 测试3: WebGL支持 -->
    <div class="test-container">
        <h2>测试3: WebGL支持检测</h2>
        <button class="test-button" onclick="testWebGL()">🧪 检测WebGL</button>
        <div id="webgl-status" class="status">等待测试...</div>
        <div id="webgl-info"></div>
    </div>
    
    <!-- 测试4: 网络连接 -->
    <div class="test-container">
        <h2>测试4: 网络连接测试</h2>
        <button class="test-button" onclick="testNetwork()">🧪 测试网络</button>
        <div id="network-status" class="status">等待测试...</div>
        <div id="network-info"></div>
    </div>

    <script src="https://webapi.amap.com/loader.js"></script>
    <script>
        // 测试高德地图
        async function testAMap() {
            const statusEl = document.getElementById('amap-status');
            const containerEl = document.getElementById('amap-container');
            
            statusEl.className = 'status loading';
            statusEl.textContent = '🔄 正在加载高德地图...';
            
            try {
                const AMapLoader = window.AMapLoader;
                
                const AMap = await AMapLoader.load({
                    key: '4a7c8d1adf162d30d8a29941ee5de12f', // 测试密钥
                    version: '2.0',
                    plugins: ['AMap.Scale', 'AMap.Marker']
                });
                
                const map = new AMap.Map(containerEl, {
                    center: [116.4074, 39.9042],
                    zoom: 10,
                    viewMode: '3D',
                    pitch: 45
                });
                
                statusEl.className = 'status success';
                statusEl.textContent = '✅ 高德地图加载成功！';
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `❌ 高德地图加载失败: ${error.message}`;
                console.error('高德地图错误:', error);
            }
        }
        
        // 测试OpenStreetMap
        function testOSM() {
            const statusEl = document.getElementById('osm-status');
            const containerEl = document.getElementById('osm-container');
            
            statusEl.className = 'status loading';
            statusEl.textContent = '🔄 正在加载OSM地图...';
            
            // 简单的OSM瓦片地图实现
            containerEl.innerHTML = `
                <div style="
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, #4a90e2 0%, #7b68ee 100%);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-size: 16px;
                ">
                    <div style="text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 10px;">🗺️</div>
                        <div>OSM地图模拟显示</div>
                        <div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">
                            (实际项目中会加载真实瓦片)
                        </div>
                    </div>
                </div>
            `;
            
            statusEl.className = 'status success';
            statusEl.textContent = '✅ OSM备用方案可用！';
        }
        
        // 测试WebGL支持
        function testWebGL() {
            const statusEl = document.getElementById('webgl-status');
            const infoEl = document.getElementById('webgl-info');
            
            statusEl.className = 'status loading';
            statusEl.textContent = '🔄 检测WebGL支持...';
            
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                
                if (gl) {
                    const info = {
                        vendor: gl.getParameter(gl.VENDOR),
                        renderer: gl.getParameter(gl.RENDERER),
                        version: gl.getParameter(gl.VERSION),
                        maxTextureSize: gl.getParameter(gl.MAX_TEXTURE_SIZE)
                    };
                    
                    statusEl.className = 'status success';
                    statusEl.textContent = '✅ WebGL支持正常！';
                    
                    infoEl.innerHTML = `
                        <div style="margin-top: 10px; font-size: 12px;">
                            <div><strong>显卡厂商:</strong> ${info.vendor}</div>
                            <div><strong>渲染器:</strong> ${info.renderer}</div>
                            <div><strong>WebGL版本:</strong> ${info.version}</div>
                            <div><strong>最大纹理尺寸:</strong> ${info.maxTextureSize}</div>
                        </div>
                    `;
                } else {
                    throw new Error('WebGL不支持');
                }
                
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = `❌ WebGL检测失败: ${error.message}`;
                infoEl.innerHTML = '<div style="color: #f44336; margin-top: 10px;">您的浏览器不支持WebGL，无法使用3D地图功能</div>';
            }
        }
        
        // 测试网络连接
        async function testNetwork() {
            const statusEl = document.getElementById('network-status');
            const infoEl = document.getElementById('network-info');
            
            statusEl.className = 'status loading';
            statusEl.textContent = '🔄 测试网络连接...';
            
            const tests = [
                { name: '高德地图API', url: 'https://webapi.amap.com/maps' },
                { name: 'OpenStreetMap', url: 'https://tile.openstreetmap.org/0/0/0.png' },
                { name: 'Cesium Ion', url: 'https://api.cesium.com/v1/' }
            ];
            
            const results = [];
            
            for (const test of tests) {
                try {
                    const startTime = Date.now();
                    const response = await fetch(test.url, { 
                        method: 'HEAD',
                        mode: 'no-cors',
                        cache: 'no-cache'
                    });
                    const endTime = Date.now();
                    
                    results.push({
                        name: test.name,
                        status: '✅ 可访问',
                        time: `${endTime - startTime}ms`
                    });
                } catch (error) {
                    results.push({
                        name: test.name,
                        status: '❌ 无法访问',
                        error: error.message
                    });
                }
            }
            
            const allSuccess = results.every(r => r.status.includes('✅'));
            
            statusEl.className = allSuccess ? 'status success' : 'status error';
            statusEl.textContent = allSuccess ? '✅ 网络连接正常！' : '⚠️ 部分服务无法访问';
            
            infoEl.innerHTML = `
                <div style="margin-top: 10px; font-size: 12px;">
                    ${results.map(r => `
                        <div style="margin: 5px 0;">
                            <strong>${r.name}:</strong> ${r.status} 
                            ${r.time ? `(${r.time})` : ''}
                            ${r.error ? `- ${r.error}` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // 页面加载完成后自动运行WebGL检测
        window.onload = function() {
            testWebGL();
        };
    </script>
</body>
</html>
