<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV上传调试工具</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #f5f5f5; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input[type="file"] { margin: 10px 0; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 CSV上传和3D生成调试工具</h1>
        
        <div class="section">
            <h3>📁 1. 测试CSV文件上传</h3>
            <input type="file" id="csvFile" accept=".csv" />
            <button onclick="testCsvUpload()">测试CSV解析</button>
            <div id="csvResult" class="log"></div>
        </div>
        
        <div class="section">
            <h3>🏔️ 2. 测试地质模型生成</h3>
            <button onclick="testGeologicalModel()">生成测试地质模型</button>
            <div id="modelResult" class="log"></div>
        </div>
        
        <div class="section">
            <h3>🌐 3. 检查前端连接</h3>
            <button onclick="checkFrontend()">检查前端状态</button>
            <div id="frontendResult" class="log"></div>
        </div>
        
        <div class="section">
            <h3>🔧 4. 检查后端连接</h3>
            <button onclick="checkBackend()">检查后端状态</button>
            <div id="backendResult" class="log"></div>
        </div>
        
        <div class="section">
            <h3>📊 5. 系统诊断报告</h3>
            <button onclick="generateReport()">生成诊断报告</button>
            <div id="reportResult" class="log"></div>
        </div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }

        function testCsvUpload() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                log('csvResult', '❌ 请先选择CSV文件', 'error');
                return;
            }
            
            log('csvResult', `📁 开始解析文件: ${file.name} (${(file.size/1024).toFixed(1)}KB)`);
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = e.target.result;
                    const lines = csvData.split('\n').filter(line => line.trim());
                    
                    log('csvResult', `📊 CSV解析成功: ${lines.length}行数据`, 'success');
                    
                    if (lines.length > 0) {
                        const headers = lines[0].split(',').map(h => h.trim());
                        log('csvResult', `📋 列名: ${headers.join(', ')}`);
                        
                        // 检查必需列
                        const required = ['X', 'Y', 'Z', 'surface'];
                        const missing = required.filter(col => !headers.includes(col));
                        
                        if (missing.length > 0) {
                            log('csvResult', `❌ 缺少必需列: ${missing.join(', ')}`, 'error');
                        } else {
                            log('csvResult', '✅ CSV格式正确，包含所有必需列', 'success');
                            
                            // 统计地层
                            const surfaceData = {};
                            for (let i = 1; i < Math.min(lines.length, 100); i++) {
                                const values = lines[i].split(',');
                                const surface = values[headers.indexOf('surface')]?.trim();
                                if (surface) {
                                    surfaceData[surface] = (surfaceData[surface] || 0) + 1;
                                }
                            }
                            
                            log('csvResult', `🏔️ 检测到地层: ${Object.keys(surfaceData).map(s => `${s}(${surfaceData[s]}点)`).join(', ')}`);
                        }
                    }
                } catch (error) {
                    log('csvResult', `❌ CSV解析失败: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        function testGeologicalModel() {
            log('modelResult', '🏔️ 开始测试地质模型生成...');
            
            // 模拟地质模型数据
            const testData = {
                csvData: `X,Y,Z,surface
499300,316500,45,surface_1
499400,316600,43,surface_1
499500,316700,44,surface_1
499300,316500,35,surface_2
499400,316600,33,surface_2
499500,316700,34,surface_2`,
                layerInfo: [
                    { name: 'surface_1', pointCount: 3, avgDepth: 44 },
                    { name: 'surface_2', pointCount: 3, avgDepth: 34 }
                ]
            };
            
            try {
                log('modelResult', '📊 测试数据准备完成');
                log('modelResult', `📋 CSV数据: ${testData.csvData.split('\n').length}行`);
                log('modelResult', `🏔️ 地层信息: ${testData.layerInfo.length}层`);
                
                // 这里可以调用实际的地质模型生成函数
                log('modelResult', '✅ 地质模型测试数据验证通过', 'success');
                log('modelResult', '💡 建议检查前端控制台是否有详细的调试信息', 'warning');
                
            } catch (error) {
                log('modelResult', `❌ 地质模型测试失败: ${error.message}`, 'error');
            }
        }

        async function checkFrontend() {
            log('frontendResult', '🌐 检查前端服务状态...');
            
            try {
                const response = await fetch('http://localhost:3001/');
                if (response.ok) {
                    log('frontendResult', '✅ 前端服务正常运行 (http://localhost:3001/)', 'success');
                } else {
                    log('frontendResult', `⚠️ 前端响应异常: ${response.status}`, 'warning');
                }
            } catch (error) {
                log('frontendResult', `❌ 前端连接失败: ${error.message}`, 'error');
                log('frontendResult', '💡 请确保前端服务正在运行', 'warning');
            }
        }

        async function checkBackend() {
            log('backendResult', '🔧 检查后端服务状态...');
            
            try {
                const response = await fetch('http://localhost:8000/health');
                if (response.ok) {
                    const data = await response.json();
                    log('backendResult', '✅ 后端服务正常运行 (http://localhost:8000/)', 'success');
                    log('backendResult', `📊 后端状态: ${JSON.stringify(data, null, 2)}`);
                } else {
                    log('backendResult', `⚠️ 后端响应异常: ${response.status}`, 'warning');
                }
            } catch (error) {
                log('backendResult', `❌ 后端连接失败: ${error.message}`, 'error');
                log('backendResult', '💡 请确保后端服务正在运行', 'warning');
            }
        }

        function generateReport() {
            log('reportResult', '📊 生成系统诊断报告...');
            log('reportResult', '=== DeepCAD Pro 系统诊断报告 ===');
            log('reportResult', `🕐 生成时间: ${new Date().toLocaleString()}`);
            log('reportResult', '');
            
            log('reportResult', '🔍 已知问题:');
            log('reportResult', '1. CSV上传后没有生成3D地质体');
            log('reportResult', '2. 后端缺少依赖: email-validator, passlib');
            log('reportResult', '3. Logo显示问题（已修复）');
            log('reportResult', '4. 右键退出编辑模式功能（已添加）');
            log('reportResult', '');
            
            log('reportResult', '✅ 建议解决方案:');
            log('reportResult', '1. 打开浏览器开发者工具(F12) → Console查看详细日志');
            log('reportResult', '2. 检查replayEngine是否正确接收CSV数据');
            log('reportResult', '3. 验证3D场景是否正确更新');
            log('reportResult', '4. 安装缺失的Python依赖');
            log('reportResult', '');
            
            log('reportResult', '🚀 快速修复命令:');
            log('reportResult', 'cd deep_excavation');
            log('reportResult', 'pip install email-validator passlib');
            log('reportResult', 'python start_simple.py  # 启动后端');
            log('reportResult', 'python run_frontend.py  # 启动前端');
            log('reportResult', '');
            
            log('reportResult', '📖 调试步骤:');
            log('reportResult', '1. 上传CSV文件');
            log('reportResult', '2. 打开F12控制台查看日志');
            log('reportResult', '3. 查找"🏔️ 开始创建地质表面"等调试信息');
            log('reportResult', '4. 检查是否有错误或警告');
            
            log('reportResult', '=== 报告结束 ===', 'success');
        }

        // 页面加载时自动检查状态
        window.onload = function() {
            log('reportResult', '🚀 DeepCAD Pro 调试工具已加载');
            log('reportResult', '💡 建议先检查前端和后端连接状态');
        };
    </script>
</body>
</html> 